pipeline {

  options {
    skipDefaultCheckout(true)
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }

  agent any

  environment {
    NEW_VERSION = '1.0.0'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Preparar Ambiente') {
      steps {
        echo "Preparando o ambiente"
        // Instala o Python e o Pip (ajustar conforme o sistema operacional)
        sh '''
          sudo apt-get update
          sudo apt-get install -y python3
          sudo apt-get install -y python3-pip
          pip3 --version
        '''
      }
    }

    stage('Build') {
      steps {
        echo "Building"
        echo "Building version ${NEW_VERSION}"
        // Alterado para pip3 para garantir que estamos usando a versão do Python 3
        sh 'pip3 install -r src/requirements.txt'
      }
    }

    stage('Lint') {
      steps {
        echo "Linting"
        // sh 'pylint **/*.py'
      }
    }

    stage('Test') {
      steps {
        echo "Testando a aplicação"
        echo "Testado com sucesso !"
        // sh 'python3 test.py' // Alterado para python3
      } 
    }

    stage('Deploy')
    {
      steps {
        echo "Deploying the application"
      }
    }
  }

  post {
    always {
      echo 'The pipeline completed'
      // junit allowEmptyResults: true, testResults:'**/test_reports/*.xml'
    }
    success {
      echo "Flask Application Up and running!!"
    }
    failure {
      echo 'Build stage failed'
      error('Stopping early…')
    }
    unstable {
      echo 'This will run only if the run was marked as unstable'
    }
    changed {
      echo 'This will run only if the state of the Pipeline has changed'
      echo 'For example, if the Pipeline was previously failing but is now successful'
    }
  }
}
